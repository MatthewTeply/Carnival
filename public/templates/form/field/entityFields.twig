<style>
    .field-container {
        position: relative;
        border-radius: 3px;
        padding: 15px;
        height: auto;
        color: #000;
        margin: 8px 0;
        font-size: 14px;
        background-color: rgba(255, 255, 255, .1);
        border: 2px solid var(--col-side-nav);
    }

    .entity-field-label {
        display: block;
        margin-top: 10px;
        margin-bottom: 4px;
    }

    .entity-field-label:first-of-type {
        margin-top: 0;
    }

    .metadata-container .row {
        margin-bottom: 10px;
    }

    .metadata-container .col {
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

<div class="col-lg-12 form-input-around">
    <div class="field-label">{{ label }}</div>

    <input type="hidden" id="entity-json-{{ name }}" name="{{ name }}[value]">

    <div class="form-control" id="app-entity-fields">
        <div class="field-container" v-for="(field, fieldKey) in fields">
            <b class="entity-field-label">Entity name</b>
            <input type="text" class="form-control" placeholder="Entity name" v-on:change="updateJson" v-model="field['name']">

            <b class="entity-field-label">Type</b>
            <input type="text" class="form-control" placeholder="Entity type" v-on:change="updateJson" v-model="field['type']">

            <b class="entity-field-label">Metadata</b>
            <div class="form-control">
                <div class="container metadata-container">
                    <div class="row" v-for="(data, dataKey) in field['metadata']">
                        <div class="col col-5">
                            <input type="text" class="form-control" placeholder="Key" v-on:change="updateJson" v-model="data['key']">
                        </div>
                        <div class="col col-sm-1">
                            <i class="fas fa-long-arrow-alt-right"></i>
                        </div>
                        <div class="col col-6">
                            <input type="text" class="form-control" placeholder="Value" v-on:change="updateJson" v-model="data['value']">
                        </div>
                    </div>

                    <button type="button" class="btn btn-black" v-on:click="addMetadata(fieldKey)"><i class="fas fa-plus"></i> Add data</button>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-black" v-on:click="addField"><i class="fas fa-plus"></i> Add field</button>
    </div>
</div>

<script>
    window.fields = new Vue({
        el: '#app-entity-fields',
        delimiters: ['${', '}'],
        data: {
            fields: []
        },
        methods: {
            updateJson() {
                let json = {};

                for(let field of this.fields) {
                    json[field.name] = {
                        type: field.type,
                        metadata: {}
                    }

                    for(let data of field.metadata) {
                        json[field.name].metadata[data.key] = data.value;
                    }
                }

                document.querySelector('#entity-json-{{ name }}').value = JSON.stringify(json);

                console.log(json);
            },
            addField() {
                this.fields.push({
                    name: '',
                    type: '',
                    metadata: []
                });

                this.updateJson();
            },
            addMetadata(fieldIndex) {
                this.fields[fieldIndex].metadata.push({});

                this.updateJson();
            }
        }
    });
</script>